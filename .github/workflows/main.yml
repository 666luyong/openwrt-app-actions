name: Build IPKs

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      applications:
        description: 'build applications, eg: "luci-app-store luci-app-ddnsto". "all" means build all'
        required: true
        default: 'all'
      target:
        description: 'build target ["arm64", "x64", "mipsel", "all"]'
        required: true
        default: 'all'

env:
  TZ: Asia/Shanghai

jobs:
  matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Detect build target
        id: set-matrix
        env:
          MATRIX_TARGET: ${{ github.event.inputs.target }}
        run: |
          if [ "x${MATRIX_TARGET}" = "x" -o "x${MATRIX_TARGET}" = "xall" ]; then
            echo "matrix={\"target\":[\"arm64\", \"x64\", \"mipsel\"]}" >> $GITHUB_OUTPUT
          else
            targets=""
            for target in ${MATRIX_TARGET}; do
              targets="$targets, \"$target\""
            done
            echo "matrix={\"target\":[${targets#, }]}" >> $GITHUB_OUTPUT
          fi

  build:
    needs: matrix
    runs-on: ubuntu-latest
    name: Build IPKs for ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.matrix.outputs.matrix)}}

    steps:
      - name: Job Info
        run: |
          apps="${{ github.event.inputs.applications }}"
          echo "::notice title=Apps::$apps"

      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: 'apps'

      - name: Import Env
        env:
          MATRIX_TARGET: ${{ matrix.target }}
        run: cat apps/.github/workflows/${MATRIX_TARGET}.env >> "$GITHUB_ENV"

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euxo pipefail
          sudo swapoff -a || true
          sudo rm -rf /swapfile /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo find /etc/apt/sources.list.d ! -name 'ubuntu.sources' -type f -exec rm -f {} +
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch unzip zlib1g-dev libc6-dev-i386 subversion flex uglifyjs gcc-multilib g++-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler antlr3 gperf rsync
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo ln -s /usr/bin/python3 /usr/bin/python3.10 || true
          sudo timedatectl set-timezone "$TZ"

      - name: Download SDK
        run: |
          set -euxo pipefail
          wget -q "${SDK_URL}${SDK_NAME}.tar.xz"

      - name: Unpack SDK
        run: |
          set -euxo pipefail
          mkdir -p ~/openwrt-sdk
          tar -xJf "$(pwd)/${SDK_NAME}.tar.xz" --strip-components=1 -C ~/openwrt-sdk
          ln -sf ${HOME}/openwrt-sdk ${SDK_NAME}

      - name: Clean Code
        run: |
          set -euxo pipefail
          rm -f ${SDK_NAME}/package/linux/modules/* || true
          rm -f ${SDK_NAME}/package/kernel/linux/modules/* || true
          grep -lFr '$(call KernelPackage,' ${SDK_NAME}/package/linux | xargs -rn1 sed -i 's/ FILES:=/ XFILES:=/g' || true
          grep -lFr '$(call KernelPackage,' ${SDK_NAME}/package/kernel | xargs -rn1 sed -i 's/ FILES:=/ XFILES:=/g' || true
          find ${SDK_NAME}/target/linux -name 'modules.mk' | xargs -rn1 sed -i 's/ FILES:=/ XFILES:=/g' || true
          grep 'src-git base ' ${SDK_NAME}/feeds.conf.default > ${SDK_NAME}/feeds.conf
          grep 'src-git luci ' ${SDK_NAME}/feeds.conf.default >> ${SDK_NAME}/feeds.conf

      - name: Write Config
        run: |
          set -euxo pipefail
          cat <<EOF >${SDK_NAME}/.config
          # CONFIG_SIGNED_PACKAGES is not set
          CONFIG_LUCI_LANG_zh_Hans=y
          CONFIG_LUCI_LANG_zh-cn=y
          EOF

      - name: Load custom feeds
        run: |
          set -euxo pipefail
          echo "" >> ${SDK_NAME}/feeds.conf
          echo "src-link apps $(pwd)/apps/applications" >> ${SDK_NAME}/feeds.conf
          cat apps/feeds.conf >> ${SDK_NAME}/feeds.conf
          echo "" >> ${SDK_NAME}/feeds.conf
          echo "Final feeds.conf:"
          cat ${SDK_NAME}/feeds.conf

      - name: Restore feeds from cache
        uses: actions/cache@v3
        env:
          CACHE_NAME: 'feeds-cache'
        with:
          path: |
            ~/openwrt-sdk/feeds/packages
            ~/openwrt-sdk/feeds/luci
          key: ${{ env.CACHE_NAME }}-${{ env.SDK_NAME }}-pl-3

      - name: Restore staging from cache
        uses: actions/cache@v3
        env:
          CACHE_NAME: 'staging-cache'
        with:
          path: ~/openwrt-sdk/staging_dir
          key: ${{ env.CACHE_NAME }}-${{ env.SDK_NAME }}-hht-2

      - name: Update feeds
        run: |
          set -euxo pipefail
          apps="${{ github.event.inputs.applications }}"
          cd ~/openwrt-sdk
          ./scripts/feeds update -a
          grep -lFr '$(call KernelPackage,' feeds/base/package/linux | xargs -rn1 sed -i 's/ FILES:=/ XFILES:=/g' || true
          grep -lFr '$(call KernelPackage,' feeds/base/package/kernel | xargs -rn1 sed -i 's/ FILES:=/ XFILES:=/g' || true
          patch -d feeds/luci -p1 -f -N -i ${{ github.workspace }}/apps/.github/workflows/luci.patch
          if [ "$apps" = "all" ]; then
            ./scripts/feeds install -a -p apps -d y
            for repo in $(sed -e 's/src-[^ ]* \([^ ]*\) .*/\1/g' ${{ github.workspace }}/apps/feeds.conf); do
              echo "add all in repo $repo"
              ./scripts/feeds install -a -p "$repo" -d y
            done
          else
            ./scripts/feeds install -d y ${apps}
          fi

      - name: Defconfig
        id: defconfig
        run: |
          set -euxo pipefail
          cd ~/openwrt-sdk
          make defconfig
          sed -i 's/^CONFIG_PACKAGE_\(.*\)=m$/# CONFIG_PACKAGE_\1 is not set/' .config
          grep '^CONFIG_PACKAGE_' .config || true
          echo "status=success" >> $GITHUB_OUTPUT

      # ---- DL CACHE (关键修复：不要用固定 key) ----
      - name: Restore downloads from cache
        id: dl-cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/.dl
          key: dl-${{ env.SDK_NAME }}-v4
          restore-keys: |
            dl-${{ env.SDK_NAME }}-

      # ---- PRECHECK：打印并清理“已知问题文件”，防止 download.pl 直接因旧文件报错退出 ----
      - name: Preflight dl cache (show & purge suspect file)
        run: |
          set -euxo pipefail
          mkdir -p "${{ github.workspace }}/.dl"

          echo "==== before purge: listing (.dl) ===="
          ls -lah "${{ github.workspace }}/.dl" | tail -n 200 || true

          if [ -f "${{ github.workspace }}/.dl/ddnsto-binary-4.0.1.tar.gz" ]; then
            echo "==== cached ddnsto-binary-4.0.1.tar.gz info ===="
            ls -lh "${{ github.workspace }}/.dl/ddnsto-binary-4.0.1.tar.gz" || true
            file  "${{ github.workspace }}/.dl/ddnsto-binary-4.0.1.tar.gz" || true
            sha256sum "${{ github.workspace }}/.dl/ddnsto-binary-4.0.1.tar.gz" || true
          fi

          rm -f "${{ github.workspace }}/.dl/ddnsto-binary-4.0.1.tar.gz" \
                "${{ github.workspace }}/.dl/ddnsto-binary-4.0.1.tar.gz".* || true

          echo "==== after purge: listing (.dl) ===="
          ls -lah "${{ github.workspace }}/.dl" | tail -n 200 || true

      # ---- DOWNLOAD：不让失败中断 job，必须产出 rc，保证后续诊断会跑 ----
      - name: Download sources (verbose + log, never stop job here)
        id: download
        if: steps.defconfig.outputs.status == 'success'
        shell: bash
        run: |
          set -u
          mkdir -p "${{ github.workspace }}/.dl"
          cd ~/openwrt-sdk
          rm -rf dl
          ln -s "${{ github.workspace }}/.dl" dl

          set +e
          make -j1 V=s download 2>&1 | tee /tmp/openwrt-download.log
          rc=${PIPESTATUS[0]}
          set -e

          echo "rc=$rc" >> "$GITHUB_OUTPUT"
          echo "download rc=$rc"
          exit 0

      # ---- DIAGNOSE：always 运行；从日志抽 download.pl + curl 再下载验证 ----
      - name: Diagnose download failure (hash mismatch / HTTP / content)
        if: always() && steps.defconfig.outputs.status == 'success' && steps.download.outputs.rc != '0'
        shell: bash
        run: |
          set -euxo pipefail
          log=/tmp/openwrt-download.log

          echo "==== Last 200 lines of download log ===="
          tail -n 200 "$log" || true

          # 尝试先定位 hash mismatch 行
          line="$(grep -E 'Hash of the local file .* does not match' "$log" | tail -n 1 || true)"
          echo "==== Mismatch line ===="
          echo "$line" || true

          # 兜底：拿最后一次 download.pl 命令
          cmd="$(grep -F 'scripts/download.pl' "$log" | tail -n 1 || true)"

          if [ -n "$line" ]; then
            fn="$(echo "$line" | sed -n 's/.*Hash of the local file \([^ ]*\) does not match.*/\1/p')"
            cmd="$(grep -F 'scripts/download.pl' "$log" | grep -F "\"$fn\"" | tail -n 1 || true)"
          else
            fn="$(echo "$cmd" | awk -F'"' '{print $6}' || true)"
          fi

          echo "==== download.pl cmd (selected) ===="
          echo "$cmd" || true

          url_base="$(echo "$cmd" | awk -F'"' '{print $12}' || true)"
          echo "url=${url_base}${fn}"

          echo "==== dl dir listing (workspace .dl) ===="
          ls -lah "${{ github.workspace }}/.dl" | tail -n 200 || true

          echo "==== Re-download with curl to verify remote content ===="
          rm -f "/tmp/$fn" /tmp/dl.headers || true
          curl -fL --retry 5 --retry-connrefused --retry-delay 2 \
            -H 'Cache-Control: no-cache' -H 'Pragma: no-cache' \
            -D /tmp/dl.headers -o "/tmp/$fn" "${url_base}${fn}" || true

          echo "==== HTTP headers ===="
          cat /tmp/dl.headers || true

          echo "==== File info ===="
          ls -lh "/tmp/$fn" || true
          file "/tmp/$fn" || true
          sha256sum "/tmp/$fn" || true

          if echo "$fn" | grep -qE '\.tar\.gz$'; then
            gzip -t "/tmp/$fn" && echo "gzip OK" || echo "gzip BAD"
          fi

      - name: Fail build if download failed
        if: steps.defconfig.outputs.status == 'success' && steps.download.outputs.rc != '0'
        run: |
          echo "download failed with rc=${{ steps.download.outputs.rc }}"
          exit 1

      # ---- CCache ----
      - name: Restore ccache from cache
        id: ccache-cache
        uses: actions/cache@v3
        env:
          CACHE_NAME: 'ccache-cache'
        with:
          path: ~/openwrt-sdk/.ccache
          key: ${{ env.CACHE_NAME }}-${{ env.SDK_NAME }}-2

      # ---- BUILD ----
      - name: PreCompile IPKs
        id: precompile
        if: steps.download.outputs.rc == '0'
        run: |
          set -euxo pipefail
          cd ~/openwrt-sdk
          make -j4 package/compile

      - name: ReCompile IPKs (verbose)
        id: compile
        if: failure() && steps.download.outputs.rc == '0'
        run: |
          set -euxo pipefail
          cd ~/openwrt-sdk
          bash -c 'set -o pipefail ; make -j1 V=s defconfig package/compile 2>&1 | tee /tmp/openwrt-sdk-build.log'

      - name: Last fail log
        if: failure() && steps.download.outputs.rc == '0'
        run: |
          tail -n 200 /tmp/openwrt-sdk-build.log
          false

      # ---- UPLOAD ----
      - name: PreUpload - Clean
        if: success() && (steps.precompile.outcome == 'success' || steps.compile.outcome == 'success')
        run: |
          set -euxo pipefail
          cd ${SDK_NAME}/bin/packages/${SDK_ARCH}
          rm -rf base luci

      - name: Upload bin directory
        uses: actions/upload-artifact@main
        if: success() && (steps.precompile.outcome == 'success' || steps.compile.outcome == 'success')
        with:
          name: ${{ env.SDK_ARCH }}
          path: ${{ env.SDK_NAME }}/bin/packages/${{ env.SDK_ARCH }}

      - name: PreCache - Clean
        if: always()
        run: |
          set -euxo pipefail
          # 注意：如果 feeds/luci 没有新 commit，HEAD^ 可能失败；这里加 || true 保守处理
          git -C "${SDK_NAME}/feeds/luci" reset --hard HEAD^ || true
          cd ${SDK_NAME}/staging_dir
          rm -rf packages target-* || true
